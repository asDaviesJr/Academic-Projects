AWSTemplateFormatVersion: 2010-09-09

Resources:
    LambdaRole:
        Type: AWS::IAM::Role
        Properties:
            AssumeRolePolicyDocument: 
                Version: "2012-10-17"
                Statement: 
                - 
                    Effect: "Allow"
                    Principal: 
                        Service: 
                            - "lambda.amazonaws.com"
                            - "comprehend.amazonaws.com"
                    Action: 
                        - "sts:AssumeRole"
            Policies:
                - PolicyName: ComprehendDataAccessRolePolicy
                  PolicyDocument:
                        Version: "2012-10-17"
                        Statement:
                            - Effect: Allow
                              Action: 
                                - 's3:GetObject'
                                - 's3:ListBucket'
                                - 's3:PutObject'
                              Resource:
                                - 'arn:aws:s3:::*Comprehend*'
                                - 'arn:aws:s3:::*comprehend*'
                - PolicyName: AmazonS3FullAccess
                  PolicyDocument:
                        Version: "2012-10-17"
                        Statement:
                            - Effect: Allow
                              Action: 
                                - 's3:*' 
                                - 's3-object-lambda:*' 
                              Resource: '*'
            RoleName: LambdaRole

    SentimentFunction:
        Type: AWS::Lambda::Function
        Properties: 
            Code:
                ZipFile: |
                    import boto3
            
                    client = boto3.client('comprehend')
                    
                    def lambda_handler(event, context):
                        result = {
                            "Sentiment": client.detect_sentiment(Text = event['inputTranscript'], LanguageCode='en')['Sentiment'],
                            "SentimentScore": client.detect_sentiment(Text = event['inputTranscript'], LanguageCode='en')['SentimentScore']
                        }
                        return result
            Handler: lambda_function.lambda_handler
            Role: !GetAtt LambdaRole.Arn
            Runtime: 'python3.9'